@page "/"
@using PEngine.ComponentModels
@using PEngine.Services

@inject MainLayoutViewModel vm
@inject NavigationManager navManager
@inject PostService postService;

<PageTitle>PEngine Main</PageTitle>

<ExplorerView @ref="_view" />

@code{
    private ExplorerView? _view;

    protected override Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && _view is not null)
        {
            vm.BusyLoad(async () =>
            {
                var fetchList = await postService.FetchLatest();
                await _view.AddRange(fetchList);
            });
            
            _view.OnEntryDblClick += WhenItemClicked;
        }

        return base.OnAfterRenderAsync(firstRender);
    }

    // TODO: how to share with search page?
    private void WhenItemClicked(IExplorerItem item)
    {
        vm.BusyLoad(async () =>
        {
            await Task.Run(() => navManager.NavigateTo($"/post/{item.Tag}"));
        });
    }

}